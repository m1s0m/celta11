<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wordle Celta ‚Äî Apellidos</title>
<style>
  :root{--bg:#e9f6ff;--card:#fff;--accent:#0074D9}
  body{font-family:system-ui,Arial;margin:0;background:var(--bg);color:#023047;display:flex;flex-direction:column;align-items:center;padding:24px}
  header{width:100%;max-width:900px;text-align:center}
  h1{margin:6px 0}
  #controls{display:flex;gap:8px;align-items:center;justify-content:center;margin:12px 0}
  button, input[type="button"]{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  button.secondary{background:#5daedc}
  #grid{display:grid;gap:6px;margin:12px 0}
  .row{display:flex;gap:6px;justify-content:center}
  .cell{width:46px;height:46px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,.06);font-weight:700}
  .cell.correct{background:#6aaa64;color:white}
  .cell.present{background:#c9b458;color:white}
  .cell.absent{background:#787c7e;color:white}
  #inputRow{margin-top:10px;display:flex;gap:8px;justify-content:center}
  #msg{min-height:24px;text-align:center;margin-top:6px}
  .small{font-size:13px;color:#334155}
  img.player-photo{max-width:120px;border-radius:8px;display:block;margin:8px auto}
</style>
</head>
<body>
<header>
  <h1>Wordle Celta ‚Äî Apellidos</h1>
  <div class="small">6 intentos. Usa apellidos (sin acentos ni espacios). Puedes cambiar de d√≠a ‚Üê ‚Üí</div>
</header>

<div id="controls">
  <button id="prevDay" title="D√≠a anterior">‚óÄ</button>
  <div id="dateLabel"></div>
  <button id="nextDay" title="Siguiente d√≠a">‚ñ∂</button>
</div>

<div id="puzzleContainer" style="width:100%;max-width:900px">
  <div id="photoWrap" style="text-align:center;"></div>
  <div id="grid"></div>

  <div id="inputRow">
    <input id="guessInput" placeholder="Escribe apellido" autocomplete="off" />
    <button id="submitBtn">Probar</button>
  </div>

  <div id="msg"></div>
</div>

<script>
/* Wordle Celta - implementaci√≥n original
   - carga data/jugadores.json
   - apellidos normalizados (sin acentos ni espacios)
   - puzzle diario (baseDate configurable)
   - guarda intento en localStorage por d√≠a para evitar perder progreso
*/

const BASE_DATE = new Date(2024,0,1); // 1 Jan 2024 como √≠ndice base (puedes cambiar)
const MAX_ATTEMPTS = 6;
let jugadores = [];
let wordList = [];          // lista de apellidos normalizados
let playersByKey = {};     // mapa key->player (para foto y nombre)
let chosenWord = "";
let chosenPlayer = null;
let attempts = [];
let gameDate = new Date(); // por defecto hoy

// util normalizar: quita acentos, espacios y no-letras, y pasa a upper
function normalizeName(s){
  return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^A-Za-z]/g,'').toUpperCase();
}

function daysBetween(a,b){
  const ms = 24*60*60*1000;
  return Math.floor((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()) - Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()))/ms);
}

function dateToKey(d){
  return d.toISOString().slice(0,10);
}

function pickWordForDate(d){
  const idx = Math.abs(daysBetween(BASE_DATE, d)) % wordList.length;
  return wordList[idx];
}

function saveState(){
  localStorage.setItem('wordle_state_' + dateToKey(gameDate), JSON.stringify(attempts));
}

function loadState(){
  const raw = localStorage.getItem('wordle_state_' + dateToKey(gameDate));
  attempts = raw ? JSON.parse(raw) : [];
}

function buildGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = "";
  const len = chosenWord.length;
  grid.style.gridTemplateColumns = '';
  for(let r=0;r<MAX_ATTEMPTS;r++){
    const row = document.createElement('div');
    row.className = 'row';
    for(let c=0;c<len;c++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.r = r; cell.dataset.c = c;
      row.appendChild(cell);
    }
    grid.appendChild(row);
  }
}

function renderAttempts(){
  const len = chosenWord.length;
  const grid = document.getElementById('grid');
  // clear
  grid.querySelectorAll('.cell').forEach(cell=>{
    cell.textContent=''; cell.classList.remove('correct','present','absent');
  });
  // render each attempt
  attempts.forEach((guess, r)=>{
    const status = evaluateGuess(guess, chosenWord);
    for(let i=0;i<len;i++){
      const cell = grid.querySelector(`.cell[data-r="${r}"][data-c="${i}"]`);
      cell.textContent = guess[i];
      cell.classList.add(status[i]);
    }
  });
}

function evaluateGuess(guess, secret){
  // both are uppercase strings, same length
  const len = secret.length;
  const status = new Array(len).fill('absent');
  const secretArr = secret.split('');
  const guessArr = guess.split('');
  // first pass correct
  for(let i=0;i<len;i++){
    if(guessArr[i] === secretArr[i]){
      status[i] = 'correct';
      secretArr[i] = null;
      guessArr[i] = null;
    }
  }
  // second pass present
  for(let i=0;i<len;i++){
    if(!guessArr[i]) continue;
    const idx = secretArr.indexOf(guessArr[i]);
    if(idx !== -1){
      status[i] = 'present';
      secretArr[idx] = null;
    }
  }
  return status;
}

function showMessage(txt, err=false){
  const m = document.getElementById('msg'); m.textContent = txt;
  m.style.color = err ? 'crimson' : '#065a9e';
}

function updatePhotoAndTitleOnWin(){
  const wrap = document.getElementById('photoWrap'); wrap.innerHTML = '';
  if(chosenPlayer && chosenPlayer.foto){
    const img = document.createElement('img');
    img.src = chosenPlayer.foto;
    img.alt = chosenPlayer.nombre + ' ' + chosenPlayer.apellido;
    img.className = 'player-photo';
    wrap.appendChild(img);
  }
  if(chosenPlayer){
    const p = document.createElement('div');
    p.style.fontWeight='700';
    p.textContent = `S√≠, son ${chosenPlayer.nombre} ${chosenPlayer.apellido}`;
    wrap.appendChild(p);
  }
}

function setDate(d){
  gameDate = d;
  document.getElementById('dateLabel').textContent = dateToKey(gameDate);
  chosenWord = pickWordForDate(gameDate);
  chosenPlayer = playersByKey[chosenWord] || null;
  loadState();
  buildGrid();
  renderAttempts();
  showMessage('');
  if(attempts.includes(chosenWord)){
    showMessage('Ya jugaste y acertaste este d√≠a ‚úÖ');
    updatePhotoAndTitleOnWin();
  }
}

document.getElementById('prevDay').addEventListener('click', ()=>{
  const dt = new Date(gameDate); dt.setDate(dt.getDate()-1); setDate(dt);
});
document.getElementById('nextDay').addEventListener('click', ()=>{
  const dt = new Date(gameDate); dt.setDate(dt.getDate()+1);
  const today = new Date(); if(dt > today) return; // no futuros
  setDate(dt);
});

document.getElementById('submitBtn').addEventListener('click', submitGuess);
document.getElementById('guessInput').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') submitGuess(); });

function submitGuess(){
  const raw = document.getElementById('guessInput').value || '';
  const g = normalizeName(raw);
  if(!g){ showMessage('Escribe un apellido v√°lido',true); return; }
  if(g.length !== chosenWord.length){ showMessage(`La palabra es de ${chosenWord.length} letras`,true); return; }
  if(!wordList.includes(g)){ showMessage('Ese apellido no est√° en la lista (usa apellidos de la base de datos).',true); return; }
  if(attempts.length >= MAX_ATTEMPTS){ showMessage('No te quedan intentos', true); return; }
  attempts.push(g);
  saveState();
  renderAttempts();
  document.getElementById('guessInput').value = '';
  if(g === chosenWord){
    showMessage('¬°Correcto! üéâ');
    updatePhotoAndTitleOnWin();
  } else if(attempts.length >= MAX_ATTEMPTS){
    showMessage('Se acabaron los intentos. La respuesta era: ' + chosenWord, true);
  } else {
    showMessage(`${MAX_ATTEMPTS - attempts.length} intentos restantes`);
  }
}

// carga jugadores y prepara listas
fetch('data/jugadores.json').then(r=>r.json()).then(data=>{
  jugadores = data;
  // build normalized lastnames list (apellidos)
  const tmp = [];
  jugadores.forEach(p=>{
    const key = normalizeName(p.apellido);
    if(key){
      tmp.push(key);
      // keep reference to original player (first matching)
      if(!playersByKey[key]) playersByKey[key] = p;
    }
  });
  // unique
  wordList = Array.from(new Set(tmp));
  // if very short or contains varying lengths that's ok
  // set today as default
  setDate(new Date());
}).catch(err=>{
  document.body.innerHTML = "<p style='color:crimson'>No se pudo cargar data/jugadores.json ‚Äî pon el archivo en /data/jugadores.json</p>";
  console.error(err);
});
</script>
</body>
</html>
